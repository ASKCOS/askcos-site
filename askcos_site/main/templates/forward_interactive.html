{% extends "base.html" %}
{% load staticfiles %}

{% block title %}Synthesis Predictor{% endblock %}

{% block extrahead %}
<script src="{% static 'js/browser-compat.js' %}"></script>
<script src="{% static 'js/vue.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/loader.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'css/fontawesome.min.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'css/bootstrap-tour.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'css/forward.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'css/vue-modal.css' %}" type="text/css">
<script src="{% static 'js/bootstrap-tour.min.js' %}"></script>
{% endblock %}

{% block page_title %}
Synthesis Predictor
{% endblock %}

{% block page_body %}

<div id="app" class="container-fluid">

<!-- template for the modal component -->
<script type="text/x-template" id="modal-template">
  <transition name="modal">
    <div class="modal-mask">
      <div class="modal-wrapper" @click.self="$emit('close')">
        <div class="modal-container">

          <div class="modal-header">
            <slot name="header">
              default header
            </slot>
          </div>

          <div class="modal-body">
            <slot name="body">
              default body
            </slot>
          </div>

          <div class="modal-footer">
            <slot name="footer">
              <button class="btn btn-dark modal-default-button" @click="$emit('close')">
                <slot name="button-text">
                  Close
                </slot>
              </button>
            </slot>
          </div>
        </div>
      </div>
    </div>
  </transition>
</script>

<modal style="z-index: 9999" v-if="showSettings" @close="showSettings = false">
    <div class="mx-auto" slot="header">
        <h1>Settings</h1>
    </div>
    <div slot="body" class="text-left">
        <div class="page-header">
            <h2>Model selections</h2>
        </div>
        <div class="form-inline">
            <label style="margin: 5px">
                Condition recommendation model: 
                <select class='form-control' v-model="contextModel"> 
                    <option value="neuralnetwork">Neural Network</option>
                </select>
            </label>
        </div>
        <div class="form-inline">
            <label style="margin: 5px">
                Forward prediction model: 
                <select class='form-control' v-model="forwardModel"> 
                    <option value="wln">WLN</option>
                </select>
            </label>
        </div>
        <div class="form-inline">
            <label style="margin: 5px">
                Reaction scoring model: 
                <select class='form-control' v-model="inspectionModel"> 
                    <option value="fastFilter">Fast Filter</option>
                </select>
            </label>
        </div>
        <div class="form-inline">
            <label style="margin: 5px">
                Atom-mapping model: 
                <select class='form-control' v-model="atomMappingModel"> 
                    <option value="wln">WLN</option>
                </select>
            </label>
        </div>
        
        <div class="page-header">
            <h2>Impurity predictor settings</h2>
        </div>
        <div class="form-inline">
            <label style="margin: 5px">
                Top-k from forward prediction: <span class="glyphicon glyphicon-info-sign" title="How many of the top forward prediction products should be included in impurity prediction?"></span>
                <input type='number' class='form-control' v-model="impurityTopk"/>
            </label>
        </div>
        <div class="form-inline">
            <label style="margin: 5px">
                Inspection threshold: <span class="glyphicon glyphicon-info-sign" title="Threshold for filtering out bad reactions"></span>
                <input type='number' step="any" class='form-control' v-model="inspectionThreshold"/>
            </label>
        </div>
        <div class="form-inline">
            <label style="margin: 5px">
                Use atom mapping: <span class="glyphicon glyphicon-info-sign" title="Whether to use atom mapping to check reaction modes"></span>
                <input type='checkbox' step="any" class='form-control' v-model="inspectionThreshold"/>
            </label>
        </div>
    </div>
</modal>

    <div class="row">
        <div class="col-12">
            <div class="row">
                <div class="col-12">
                    <div class="arrow-step-wrapper">
                        <div class="arrow-steps clearfix">
                            <div id="contextArrowStep" class="step" :class="{current: mode=='context'}" for="contextMode" @click="changeMode('context')">
                                <span> Condition recommendation </span>
                            </div>

                            <div id="forwardArrowStep" class="step" :class="{current: mode=='forward'}" for="forwardMode" @click="changeMode('forward')">
                                <span> Synthesis prediction </span>
                            </div>

                            <div id="impurityArrowStep" class="step" :class="{current: mode=='impurity'}" for="impurityMode" @click="changeMode('impurity')">  
                                <span> Impurity prediction </span>
                            </div>
                            <div style="display:inline-block;margin: 10px 20px; float: right;">
                                <button id="settings-btn" class="btn btn-default" @click="showSettings = !showSettings" title="Settings" style="margin-left: 5px"><i class="fas fa-cog"></i></button>
                                <button class="btn btn-default" @click="startTour" title="Start tutorial"><i class="fas fa-question"></i></button>
                            </div>
                        </div>
                    </div>
                    <form v-on:submit.prevent="predict" autocomplete="off">
                        <div class="row" style="margin-top:50px">
                            <div class="col-md-3 col-md-offset-3">
                                <label>Reactants: </label>
                                <div class="input-group">
                                    <input class='form-control' type="text" v-model="reactants" id="reactants"/> 
                                    <span id="reactants-edit-icon" class='btn input-group-addon' data-toggle="modal" data-target="#drawingbox" @click="drawBox('reactants')">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label>Product: </label>
                                <div class="input-group">
                                    <input class='form-control' type="text" v-model="product" :disabled="mode=='forward'" id="product"/> 
                                    <span class='btn input-group-addon'data-toggle="modal" data-target="#drawingbox" @click="drawBox('product')" :disabled="mode=='forward'">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div v-if="!!reactants" class="row text-center">
                            <img :src='"/draw/reaction/"+encodeURIComponent(reactants)+"%3E%3E"+encodeURIComponent(product)'/>
                        </div>

                        <div class="row" v-show="mode!='context'">
                            <div class="col-md-3 col-md-offset-3">
                                <label>Reagents: </label>
                                <div class="input-group">
                                    <input class='form-control' type="text" v-model="reagents" :disabled="mode=='context'" id="reagents"/> 
                                    <span class='btn input-group-addon' data-toggle="modal" data-target="#drawingbox" @click="drawBox('reagents')" :disabled="mode=='context'">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </div>
                                <div v-if="!!reagents" class="text-center">
                                    <img :src='"/draw/smiles/"+encodeURIComponent(reagents)' :alt="reagents">
                                </div>
                            </div>
                            
                            <div class="col-md-3 ">
                                <label>Solvent: </label>
                                <div class="input-group">
                                    <input class='form-control' type="text" v-model="solvent" :disabled="mode=='context'" id="solvent"/> 
                                    <span class='btn input-group-addon' data-toggle="modal" data-target="#drawingbox" @click="drawBox('solvent')" :disabled="mode=='context'">
                                        <i class="fas fa-edit"></i>
                                    </span>
                                </div>
                                <div v-if="!!solvent" class="text-center">
                                    <img :src='"/draw/smiles/"+encodeURIComponent(solvent)' :alt="solvent">
                                </div>
                            </div>
                        </div>
                        <div class=" text-center">
                            <button id="submit-button" type="submit" class='form-control' style="margin: 10px auto; width: 100px">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="context-results" v-show="mode=='context' && !!contextResults.length">
                <div class="text-center" style="margin: 10px auto">
                    <button class="btn btn-success" @click="evaluate" :disabled="evaluating==true">Evaluate reaction(s)</button>
                </div>
                <div v-if="!!reactionScore" class="text-center">
                    <b>Reaction score: %% reactionScore.toFixed(3) %%</b>
                </div>
                <table class="table table-hover" style="width: 75%; margin: 0 auto">
                    <template v-for="(result, index) in contextResults">
                        <thead>
                            <tr>
                                <th class="" colspan=6 style="padding: 50px 8px 8px 8px">

                                    Recommendation %% index+1 %% 


                                    <span v-if="evaluating && result.evaluation === undefined">
                                        <div class="loader-in-place"></div>
                                    </span>
                                    <span v-else-if="result.evaluation">
                                        ✔ (rank: %% result.evaluation %%)
                                    </span>
                                    <span v-else-if="result.evaluation != undefined && !result.evaluation">
                                        <i class="fas fa-times"></i> (rank: N/A)
                                    </span>

                                    <span style="float:right">
                                        <button class="btn btn-default" @click="goToForward(index)" :id="'predict-conditions-'+index">
                                            <i class="fas fa-arrow-right"></i> Predict with conditions
                                        </button>
                                    </span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Reagents:</td>
                                <td colspan=5>
                                    <img v-if="!!result.reagent" :src='"/draw/smiles/"+encodeURIComponent(result.reagent)' :alt="result.reagent">
                                    <span v-else>none</span>
                                </td>
                            </tr>
                            <tr>
                                <td>Catalyst:</td>
                                <td colspan=5>
                                    <img v-if="!!result.catalyst" :src='"/draw/smiles/"+encodeURIComponent(result.catalyst)' :alt="result.catalyst">
                                    <span v-else>none</span>
                                </td>
                            </tr>
                            <tr>
                                <td>Solvents:</td>
                                <td colspan=5>
                                    <img v-if="!!result.solvent" :src='"/draw/smiles/"+encodeURIComponent(result.solvent)' :alt="result.solvent">
                                    <span v-else>none</span>
                                </td>
                            </tr>
                            <tr>
                                <td>Temperature:</td>
                                <td colspan=5>%% Math.round(result.temperature) %% Celsius</td>
                            </tr>
                        </tbody>
                    </template>
                </table>
            </div>

            <table id="forward-results" v-show="mode=='forward' && !!forwardResults.length" class="table table-hover" style="width: 75%; margin: 0 auto">
                <thead>
                    <tr>
                        <th class="text-center">Rank</th>
                        <th class="text-center">Product</th>
                        <th class="text-center">Probability</th>
                        <th class="text-center">Max. Score</th>
                        <th class="text-center">Molecular Weight</th>
                        <th class="text-center">Predict impurities</th>
                    </tr>
                </thead>
                <tbody>
                    <template v-for="(res, index) in forwardResults">
                        <tr>
                            <td class="text-center">%% res.rank %%</td>
                            <td class="text-center">
                                <img :src='"/draw/smiles/"+encodeURIComponent(res.smiles)' :alt="res.smiles">
                            </td>
                            <td class="text-center">%% (Math.round((res.prob + Number.EPSILON) * 10000) / 10000).toFixed(4) %%</td>
                            <td class="text-center">%% (Math.round((res.score + Number.EPSILON) * 1000) / 1000).toFixed(3) %%</td>
                            <td class="text-center">%% (Math.round((res.mol_wt + Number.EPSILON) * 10) / 10).toFixed(1) %%</td>
                            <td class="text-center">
                                <button :id="'predict-impurities-' + index" class="btn btn-default" @click="goToImpurity(res.smiles)" title="Recommend context"><i class="fas fa-arrow-right"></i></button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>

            <div v-show="mode=='impurity'">
                <div>
                    Progress: %% impurityProgress.message %%
                </div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" :style="{ width: 100*impurityProgress.percent+'%'}" :aria-valuenow="100*impurityProgress.percent" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <table v-show="!!impurityResults.length" class="table table-hover" style="width: 75%; margin: 0 auto">
                    <thead>
                        <tr>
                            <th style="text-align: right">No. <a href="#" data-toggle="tooltip" title="Ranking is based on similarity between predicted impurity and major product."><span class="glyphicon glyphicon-info-sign"></span></a></th>
                            <th><center>Predicted impurities</center></th>
                            <th style="text-align: right">Possible mechanisms</th>
                            <th style="text-align: right">Inspector score</th>
                            <th style="text-align: right">Similarity score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template v-for="(outcome, index) in impurityResults">
                            <tr>
                                <td>%% outcome.no %%</td>
                                <td>
                                    <center>
                                        <img :src='"/draw/smiles/"+encodeURIComponent(outcome.prd_smiles)' :alt="outcome.prd_smiles"><br>
                                        <font class="smiles">%% outcome.prd_smiles %%</font>
                                    </center>
                                </td>
                                <td style="text-align: right">%% outcome.modes_name %%</td>
                                <td style="text-align: right">%% outcome.avg_insp_score.toFixed(3) %%</td>
                                <td style="text-align: right">%% outcome.similarity_to_major.toFixed(3) %%</td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="pageLoader" class="loader"></div>

    <!-- Popup drawing tool -->
    <div class="modal fade" id="drawingbox">
        <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body" style="height:430px;">
            <div id="jsme_container" style="margin:auto"></div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" @click="updateSmilesFromJSME">Done drawing</button>
            </div>
            
        </div>
        </div>
    </div>

</div>


<script src="{% static 'js/forward.js' %}"></script>

{% endblock %}
