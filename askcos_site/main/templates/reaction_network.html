{% extends "base.html" %}
{% load staticfiles %}

{% block title %}Interactive Path Planning{% endblock %}
{% block extrahead %}

<script src="{% static 'js/browser-compat.js' %}?v{{ static_version }}"></script>

<script src="{% static 'js/vue.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/vis.min.css' %}?v{{ static_version }}" type="text/css">
<link rel="stylesheet" href="{% static 'css/network.css' %}?v{{ static_version }}" type="text/css">
<link rel="stylesheet" href="{% static 'css/splash.css' %}?v{{ static_version }}" type="text/css">
<link rel="stylesheet" href="{% static 'css/bootstrap-tourist.css' %}?v{{ static_version }}" type="text/css">
<link rel="stylesheet" href="{% static 'css/vue-modal.css' %}?v{{ static_version }}" type="text/css">
<link rel="stylesheet" href="{% static 'css/tooltip.css' %}?v{{ static_version }}" type="text/css">
<script src="{% static 'js/vis.min.js' %}?v{{ static_version }}"></script>
<script src="{% static 'js/bootstrap-tourist.min.js' %}?v{{ static_version }}"></script>
{% endblock %}

{% block page_title %}Interactive Path Planning{% endblock %}

{% block page_body %}

<div id="app">

<div id="splash" class="splash-container d-flex flex-column align-items-center justify-content-center">
    <h3>
        ASKCOS Interactive Path Planning
    </h3>
    <div class="d-flex align-items-center justify-content-center">
        <div class="spinner-grow spinner-grow-sm bounce-early"></div>
        <div class="spinner-grow spinner-grow-sm mx-1"></div>
        <div class="spinner-grow spinner-grow-sm bounce-late"></div>
    </div>
</div>

<!-- drawing box -->
{% include "ketcher_modal.html" with vue=True %}
    <main>
        <!-- json file upload modal -->
        <transition name="modal">
            <div class="modal-mask" v-if="showLoadModal" @click.self="showLoadModal = false">
                <div class="modal-dialog modal-dialog-centered fade-d">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Load Network JSON</h5>
                            <button type="button" class="close" aria-label="Close" @click="showLoadModal = false">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-inline">
                                <input id="loadNetwork" class="form-control-file" type="file"/>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" @click="showLoadModal = false">Cancel</button>
                            <button type="button" class="btn btn-success" @click="showLoadModal = false; load()">Load</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- json file download modal -->
        <transition name="modal">
            <div class="modal-mask" v-if="showDownloadModal" @click.self="showDownloadModal = false">
                <div class="modal-dialog modal-dialog-centered fade-d">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Download Network JSON</h5>
                            <button type="button" class="close" aria-label="Close" @click="showDownloadModal = false">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-inline">
                                <label class="mr-2" for="downloadName">File name:</label>
                                <input id="downloadName" class="form-control" type="text" v-model="downloadName"/>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" @click="showDownloadModal = false">Cancel</button>
                            <button type="button" class="btn btn-success" @click="showDownloadModal = false; download()">Download</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- cluster view modal -->
        <transition name="modal">
            <div class="modal-mask" v-if="showClusterPopoutModal" @click.self="closeClusterPopoutModal()">
                <div class="modal-dialog modal-xl fade-d">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                View Cluster
                            </h5>
                            <button type="button" class="close" aria-label="Close" @click="closeClusterPopoutModal()">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-3">
                                <button class="btn btn-outline-dark" @click="clusterPopoutModalDecGroupID();"><i class="fas fa-arrow-left"></i></button>
                                Cluster #%% num2str(clusterPopoutModalData['group_id']+1) %%
                                <button class="btn btn-outline-dark" @click="clusterPopoutModalIncGroupID();"><i class="fas fa-arrow-right"></i></button>
                            </div>
                            <div class="scroll-list">
                                <div class="grid-wrapper">
                                    <template v-for="res in results[clusterPopoutModalData['selectedSmiles']]">
                                        <div v-if="res.group_id == clusterPopoutModalData['group_id']" class="card">
                                            <div class="container-fluid d-flex flex-column justify-content-between h-100">
                                                <div class="row">
                                                    <div class="col-xs w-100">
                                                        <table class="table table-sm table-bordered m-0">
                                                            <tbody>
                                                                <tr>
                                                                    <td>Rank</td>
                                                                    <td>#%% res.rank %%</td>
                                                                </tr>
                                                                <tr v-if="clusterPopoutModalData.optionsDisplay.showScore">
                                                                    <td>Score</td>
                                                                    <td>%% num2str(res.score, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterPopoutModalData.optionsDisplay.showSCScore">
                                                                    <td>Synthetic complexity</td>
                                                                    <td>%% num2str(res.scscore, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterPopoutModalData.optionsDisplay.showNumExample">
                                                                    <td># Examples</td>
                                                                    <td>%% num2str(res.num_examples)%%</td>
                                                                </tr>
                                                                <tr v-if="clusterPopoutModalData.optionsDisplay.showTemplateScore">
                                                                    <td>Template score</td>
                                                                    <td>%% num2str(res.template_score, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterPopoutModalData.optionsDisplay.showPlausibility">
                                                                    <td>Plausibility</td>
                                                                    <td>%% num2str(res.plausibility, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterPopoutModalData.optionsDisplay.showClusterId">
                                                                    <td>Reaction cluster</td>
                                                                    <td>%% num2str(res.group_id+1) %%</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-xs">
                                                        <img v-bind:src="getMolDrawEndPoint(res)" style="max-width: 100%"/>
                                                    </div>
                                                </div>
                                                <div class="row justify-content-end">
                                                    <div class="col-xs">
                                                        <button v-show="!res.inViz" class="addRes btn btn-sm btn-success" :data-rank="res.rank" @click="addFromResults(clusterPopoutModalData['selected'], res)"><i class="fas fa-plus"></i></button>
                                                        <button v-show="res.inViz" class="remRes btn btn-sm btn-danger" :data-rank="res.rank" @click="remFromResults(clusterPopoutModalData['selected'], res)"><i class="fas fa-minus"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div> <!-- end modal body -->
                        <div class="modal-footer justify-content-between">
                            <div>
                                <button class="btn btn-success" @click="openAddNewPrecursorModal(clusterPopoutModalData['selectedSmiles'], clusterPopoutModalData['group_id']);" title="Add precursor">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-outline-dark" @click="showClusterPopoutModal = false; openClusterEditModal(clusterPopoutModalData['selected'], clusterPopoutModalData['group_id']); closeClusterPopoutModal();" title="Edit clusters">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="form-check-inline">
                                <input class="form-check-input" id="cpShowScore" type="checkbox" v-model="clusterPopoutModalData.optionsDisplay.showScore"/>
                                <label class="form-check-label mr-2" for="cpShowScore">Score</label>
                                <input class="form-check-input" id="cpShowSCScore" type="checkbox" v-model="clusterPopoutModalData.optionsDisplay.showSCScore"/>
                                <label class="form-check-label mr-2" for="cpShowSCScore">Synthetic complexity</label>
                                <input class="form-check-input" id="cpShowNumEx" type="checkbox" v-model="clusterPopoutModalData.optionsDisplay.showNumExample"/>
                                <label class="form-check-label mr-2" for="cpShowNumEx"># Examples</label>
                                <input class="form-check-input" id="cpShowTemp" type="checkbox" v-model="clusterPopoutModalData.optionsDisplay.showTemplateScore"/>
                                <label class="form-check-label mr-2" for="cpShowTemp">Template score</label>
                                <input class="form-check-input" id="cpShowPlaus" type="checkbox" v-model="clusterPopoutModalData.optionsDisplay.showPlausibility"/>
                                <label class="form-check-label mr-2" for="cpShowPlaus">Plausibility</label>
                            </div>
                            <button type="button" class="btn btn-outline-secondary" @click="closeClusterPopoutModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- cluster edit modal -->
        <transition name="modal">
            <div class="modal-mask" v-if="showClusterEditModal" @click.self="closeClusterEditModal()">
                <div class="modal-dialog modal-xl fade-d">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                Edit Cluster
                            </h5>
                            <button type="button" class="close" aria-label="Close" @click="closeClusterEditModal()">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-3">
                                <button class="btn btn-outline-dark" @click="clusterEditModalDecGroupID();"><i class="fas fa-arrow-left"></i></button>
                                Cluster #%% num2str(clusterEditModalData['group_id']+1) %%
                                <button class="btn btn-outline-dark" @click="clusterEditModalIncGroupID();"><i class="fas fa-arrow-right"></i></button>
                            </div>
                            <div class="scroll-list-x mb-3">
                                <div class="grid-wrapper-onerow">
                                    <template v-for="res in results[clusterEditModalData['selectedSmiles']]">
                                        <div v-if="res.group_id == clusterEditModalData['group_id']" class="card" v-on:dragstart="clusteredit_dragstart_handler(res, $event)" v-on:dragend="clusteredit_dragend_handler($event);" draggable="true">
                                            <div class="container-fluid d-flex flex-column justify-content-between h-100">
                                                <div class="row">
                                                    <div class="col-xs w-100">
                                                        <table class="table table-sm table-bordered m-0 nopointer">
                                                            <tbody>
                                                                <tr>
                                                                    <td>Rank</td>
                                                                    <td>#%% res.rank %%</td>
                                                                </tr>
                                                                <tr v-if="clusterEditModalData.optionsDisplay.showScore">
                                                                    <td>Score</td>
                                                                    <td>%% num2str(res.score, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterEditModalData.optionsDisplay.showSCScore">
                                                                    <td>Synthetic complexity</td>
                                                                    <td>%% num2str(res.scscore, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterEditModalData.optionsDisplay.showNumExample">
                                                                    <td># Examples</td>
                                                                    <td>%% num2str(res.num_examples)%%</td>
                                                                </tr>
                                                                <tr v-if="clusterEditModalData.optionsDisplay.showTemplateScore">
                                                                    <td>Template score</td>
                                                                    <td>%% num2str(res.template_score, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterEditModalData.optionsDisplay.showPlausibility">
                                                                    <td>Plausibility</td>
                                                                    <td>%% num2str(res.plausibility, 3) %%</td>
                                                                </tr>
                                                                <tr v-if="clusterEditModalData.optionsDisplay.showClusterId">
                                                                    <td>Reaction cluster</td>
                                                                    <td>%% num2str(res.group_id+1) %%</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-xs">
                                                        <img v-bind:src="getMolDrawEndPoint(res)" style="max-width: 100%; pointer-events: none;" draggable="false" ondragstart="disable_dragstart_handler(event);"/>
                                                    </div>
                                                </div>
                                                <div v-if="clusterOptions.allowRemovePrecursor" class="row justify-content-end">
                                                    <div class="col-xs">
                                                        <button class="btn btn-sm btn-danger" @click="clusterEditModalDeletePrecursor(clusterEditModalData['selectedSmiles'], res.smiles);">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="scroll-list-x">
                                <div class="grid-wrapper-onerow">
                                    <template v-for="res in clusteredResults[selected.smiles]">
                                        <div class="card" style="pointer-events: all" @drop="clusteredit_drop_handler(res[0], $event);" ondragover="clusteredit_dragover_handler(event);" ondragenter="clusteredit_dragenter_handler(event);" ondragleave="clusteredit_dragleave_handler(event);" @click="clusterEditModalData['group_id'] = res[0].group_id;$forceUpdate();">
                                            <div class="container-fluid nopointer text-center">
                                                <h4 class="nonselectable nopointer">Reaction Cluster %% num2str(res[0].group_id+1) %%</h4>
                                                <div class="row nopointer">
                                                    <div class="col-xs nopointer">
                                                        <img v-bind:src="getMolDrawEndPoint(res[0])" style="max-width: 100%; pointer-events: none;" draggable="false" ondragstart="disable_dragstart_handler(event);"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    <div class="card" style="pointer-events: all" @drop="clusteredit_drop_handler_newcluster($event);" ondragover="clusteredit_dragover_handler(event);" ondragenter="clusteredit_dragenter_handler(event);" ondragleave="clusteredit_dragleave_handler(event);">
                                        <div class="container-fluid nopointer text-center">
                                            <h4 class="nonselectable nopointer">New Reaction Cluster</h4>
                                            <i class="fas fa-plus-circle fa-8x text-dark nopointer"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- end modal body -->
                        <div class="modal-footer justify-content-between">
                            <div>
                                <button class="btn btn-success" @click="openAddNewPrecursorModal(clusterEditModalData['selectedSmiles'], clusterEditModalData['group_id']);" title="Add precursor">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-outline-dark" @click="openModal('settings');" title="Open settings">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                            <div class="form-check-inline">
                                <input class="form-check-input" id="ceShowScore" type="checkbox" v-model="clusterEditModalData.optionsDisplay.showScore"/>
                                <label class="form-check-label mr-2" for="ceShowScore">Score</label>
                                <input class="form-check-input" id="ceShowSCScore" type="checkbox" v-model="clusterEditModalData.optionsDisplay.showSCScore"/>
                                <label class="form-check-label mr-2" for="ceShowSCScore">Synthetic complexity</label>
                                <input class="form-check-input" id="ceShowNumEx" type="checkbox" v-model="clusterEditModalData.optionsDisplay.showNumExample"/>
                                <label class="form-check-label mr-2" for="ceShowNumEx"># Examples</label>
                                <input class="form-check-input" id="ceShowTemp" type="checkbox" v-model="clusterEditModalData.optionsDisplay.showTemplateScore"/>
                                <label class="form-check-label mr-2" for="ceShowTemp">Template score</label>
                                <input class="form-check-input" id="ceShowPlaus" type="checkbox" v-model="clusterEditModalData.optionsDisplay.showPlausibility"/>
                                <label class="form-check-label mr-2" for="ceShowPlaus">Plausibility</label>
                            </div>
                            <div>
                                <button type="button" class="btn btn-info" @click="requestClusterId(clusterEditModalData['selectedSmiles']);">Re-cluster</button>
                                <button type="button" class="btn btn-outline-secondary" @click="closeClusterEditModal()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- add precursor modal -->
        <transition name="modal">
            <div class="modal-mask" v-if="showAddNewPrecursorModal" @click.self="closeAddNewPrecursorModal()">
                <div class="modal-dialog modal-dialog-centered fade-d">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Precursor</h5>
                            <button type="button" class="close" aria-label="Close" @click="closeAddNewPrecursorModal()">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-inline mb-2">
                                <label class="mr-2" for="precursor">Precursor: </label>
                                <div class="input-group">
                                    <input id="precursor" type="text" class="form-control text-center" v-model="addNewPrecursorModal['newprecursorsmiles']">
                                    <div v-if="enableResolve" class="input-group-append">
                                        <button class="btn btn-outline-dark" type="button" @click="toggleResolver">
                                            <i v-if="allowResolve" style="color: darkgreen" class="fas fa-server" title="Connection to NIH name resolver is ON, structures may be sent to an external service. This can be turned off in the settings menu, or by clicking this icon."></i>
                                            <i v-else style="color: darkred" class="fas fa-server" title="Connection to NIH name resolver is OFF, structures will NOT be sent to an external service. Target query must be a SMILES string. This can be turned on in the settings menu, or by clicking this icon."></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-inline mb-2">
                                <label class="mr-2" for="precursorCluster">Group:</label>
                                <select id="precursorCluster" v-model="addNewPrecursorModal['group_id']" class="form-control">
                                    <option value="undefined">New cluster</option>
                                    <option v-for="idx in clusteredResultsIndex[addNewPrecursorModal['selectedSmiles']]" :value="idx.toString()">%% idx+1 %%</option>
                                </select>
                            </div>
                            <div class="form-inline mb-2">
                                <input class="form-check-input" id="nodupcheck" type="checkbox" v-model="addNewPrecursorModal['nodupcheck']">
                                <label class="form-check-label" for="nodupcheck">No duplicate check</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" @click="closeAddNewPrecursorModal()">Cancel</button>
                            <button type="button" class="btn btn-success" @click="addNewPrecursorModalSubmit()">Add Precursor</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- settings modal -->
        <transition name="modal">
            <div class="modal-mask" v-if="showSettingsModal" @click.self="showSettingsModal = false">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable fade-l" style="margin: 1.75rem 1.75rem 1.75rem auto;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Settings</h5>
                            <button type="button" class="close" aria-label="Close" @click="showSettingsModal = false">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h4>Global settings</h4>
                            <div class="form-inline mb-2">
                                <i title="Enables the option to allow queries to be sent to PubChem name resolver. This can only be set in site configuration settings."
                                   class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="enableResolve" type="checkbox" ref="enableResolve" v-model="enableResolve" {{ enableResolve }} disabled/>
                                <label class="form-check-label" for="enableResolve">Enable option to allow queries to be sent to PubChem name resolver?</label>
                            </div>
                            <div v-if="enableResolve" class="form-inline mb-2">
                                <i title="When enabled, any input that cannot be parsed by RDKit on the ASKCOS server will be sent to the PubChem Power User Gateway API to resolve a common name (i.e. - fluconazole) to a SMILES string."
                                   class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="checkResolve" type="checkbox" ref="allowResolve" v-model="allowResolve"/>
                                <label class="form-check-label" for="checkResolve">Allow queries to be sent to PubChem name resolver?</label>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="When enabled, chemical structure images will highlight the atoms involved in a transformation." class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="checkHighlight" type="checkbox" ref="isHighlightAtom" v-model="isHighlightAtom" {{ isHighlightAtom }}/>
                                <label class="form-check-label" for="checkHighlight">Highlight changed atom?</label>
                            </div>
                            <div class="form-inline mb-1">
                                <i title="This number of results from each one-step prediction will automatically be added to the graph visualization. In some circumstances, it may be advantageous to add 0 results automatically, and manually choose which to add from the list on the right."
                                   class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="reactionLimit">Number of results to automatically add to graph:</label>
                                <input id="reactionLimit" style="width: 50px" type="number" v-model.number="reactionLimit" class="form-control form-control-sm text-center">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="When there are multiple trained models available to make a prediction, you can choose between them using this dropdown."
                                   class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="templateSet">Template set:</label>
                                <select id="templateSet" v-model="tb.settings.templateSet" @change="resetTemplateSetVersion($event)" class="form-control form-control-sm">
                                    <template v-for="(value, name) in templateSets">
                                        <option :value="name">%% name %%</option>
                                    </template>
                                </select>
                            </div>
                            <div v-if="templateAttributes && templateAttributes[tb.settings.templateSet] && templateAttributes[tb.settings.templateSet].length" class="form-inline mb-2">
                                <i title="Template attribute filters to use during retrosynthetic prediction. These are attributes that are defined for each template, and only those templates that satisfy the filter provided here will be considered. Normally, only the top 'Max. Num. templates' will be applied - with these filters, the top 'Max. Num. templates' that satisfy the filters will be applied." class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label>Template attribute filters: <i style="cursor: pointer" @click="addAttributeFilter" class="fas fa-plus ml-1"></i></label>
                            </div>
                            <div class="form-inline mb-2 ml-3" v-for="(filter, idx) in tb.settings.attributeFilter">
                                <i @click="tb.settings.attributeFilter.pop(idx)" class="fas fa-times mr-2" style="cursor: pointer"></i>
                                <select class="form-control form-control-sm mr-2" v-model="filter.name">
                                    <option v-for="attribute in templateAttributes[tb.settings.templateSet]" :value="attribute">%% attribute %%</option>
                                </select>
                                <select class="form-control form-control-sm mr-2" v-model="filter.logic">
                                    <option value="&gt;">&gt;</option>
                                    <option value="&ge;">&ge;</option>
                                    <option value="&lt;">&lt;</option>
                                    <option value="&le;">&le;</option>
                                    <option value="==">==</option>
                                </select>
                                <input class="form-control form-control-sm mr-2" type="number" v-model="filter.value">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="When multiple versions of a template relevance model are available for a given template set, you can choose between them here." class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="templateSetVersion">Relevance model version:</label>
                                <select id="templateSetVersion" v-model="tb.settings.templateSetVersion" class="form-control form-control-sm">
                                    <template v-for="version in templateSets[tb.settings.templateSet]">
                                        <option :value="version">%% version %%</option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This settings changes how the precursors are ranked by the server. Results can also be re-ordered dynamically as explained in the tutorial."
                                   class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="precursorScoring">Precursor scoring:</label>
                                <select id="precursorScoring" v-model="tb.settings.precursorScoring" class="form-control form-control-sm">
                                    <option value="RelevanceHeuristic">Relevance+Heuristic</option>
                                    <option value="SCScore">SCScore</option>
                                </select>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is the maximum number of reaction rules/templates to try to apply to your target. Depending on the value of maximum cumulative probability (below), a fewer number of templates may actually be applied."
                                   class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="numTemplates">Max. Num. templates:</label>
                                <input id="numTemplates" style="width: 100px" type="number" v-model.number="tb.settings.numTemplates" class="form-control form-control-sm text-center">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is the cumulative template score after which templates will stop being applied to your target.
For example, if the sum of the scores of the top two templates exceeds this value, only those two template application results will be returned.
For computational efficiency, this value is limited to a maximum value of 0.99999. Please directly use the asynchronous API if you need to apply all templates."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxCumProb">Max. cum. prob.:</label>
                                <input id="maxCumProb" style="width: 100px" type="number" min="0" max="1" step="0.000001" v-model.number="tb.settings.maxCumProb" @change="tb.settings.maxCumProb = Math.min(0.99999, tb.settings.maxCumProb)" class="form-control form-control-sm text-center">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is the minimum plausibility that a predictor transformation must receive from the Fast Filter model in order to be kept and returned as a result.
The plausibility score can help filter out bad suggestions, but in some cases can be over conservative and filter out false negatives."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="minPlausibility">Min. plausibility:</label>
                                <input id="minPlausibility" style="width: 100px" type="number" min="0" max="1" step="0.000001" v-model.number="tb.settings.minPlausibility" class="form-control form-control-sm text-center">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="When enabled, will automatically identify reactions which have potential regio-selectivity considerations." class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="checkSelec" type="checkbox" ref="allowSelec" v-model="tb.settings.allowSelec" {{ tb.settings.allowSelec }}/>
                                <label class="form-check-label" for="checkSelec">Apply regio-selectivity checking?</label>
                            </div>
                            <hr>
                            <h4>MCTS Tree Builder Settings:</h4>
                            <h5>MCTS algorithm options</h5>
                            <div class="form-inline mb-2">
                                <i title="Which tree builder algorithm to use."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="tbVersion">Tree builder version:</label>
                                <select id="tbVersion" v-model="tb.settings.version" class="form-control form-control-sm">
                                    <option value="1">v1</option>
                                    <option value="2" disabled>v2</option>
                                </select>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is how long the server is allowed to search for template applications.
It is roughly how long it will take for results to be returned, however there is an additional pathway resolution step following expansion that may take some time as well."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="expansionTime">Expansion time (seconds):</label>
                                <input id="expansionTime" style="width: 100px" class="form-control form-control-sm text-center" type="number" min="1" max="300" step="1" v-model.number="tb.settings.expansionTime">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is how many iterations the MCTS algorithm is allowed to perform before returning results."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxIterations">Maximum iterations (v2 only):</label>
                                <input id="maxIterations" style="width: 100px" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.maxIterations">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is how many chemicals the MCTS algorithm is allowed to explore before returning results."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxChemicals">Maximum chemicals (v2 only):</label>
                                <input id="maxChemicals" style="width: 100px" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.maxChemicals">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is how many reactions the MCTS algorithm is allowed to explore before returning results."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxReactions">Maximum reactions (v2 only):</label>
                                <input id="maxReactions" style="width: 100px" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.maxReactions">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is the maximum depth (or number of steps) for any given reaction pathway return by the search algorithm." class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxDepth">Max expansion depth:</label>
                                <input id="maxDepth" style="width: 100px" type="number" min="1" max="9" step="1" v-model.number="tb.settings.maxDepth" class="form-control form-control-sm text-center">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This is the maximum branching for any given chemical in the reaction tree/graph. Once this maximum branching factor is reached, no more template applications will be attempted for that chemical during the search."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxDepth">Max branching:</label>
                                <input id="maxBranching" style="width: 100px" class="form-control form-control-sm text-center" type="number" min="1" max="50" step="1" v-model.number="tb.settings.maxBranching">
                            </div>
                            <h5>Terminal chemical criteria</h5>
                            <p>The following options allow you to set additional criteria to be used in determining whether a precursor is terminal. All AND criteria must be satisfied simultaneously. Any OR criteria are sufficient on their own.</p>
                            <div class="form-inline mb-2">
                                <i title="Restrict buyables database lookup to specific sources. Note that this also applies to one-step predictions."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <span class="mr-2" for="buyablesSourceType">Buyables sources:</span>
                                <div class="dropdown">
                                    <button class="form-control form-control-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        %% tb.settings.buyablesSourceAll ? 'All' : tb.settings.buyablesSource.length ? tb.settings.buyablesSource.toString() : 'Select Sources' %%
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <form>
                                            <div class="form-check justify-content-start m-2">
                                                <input class="form-check-input" id="buyablesCheckAll" type="checkbox" value="all" v-model="tb.settings.buyablesSourceAll" @change="tb.settings.buyablesSource = []">
                                                <label class="form-check-label" for="buyablesCheckAll">All</label>
                                            </div>
                                            <div class="form-check justify-content-start m-2" v-for="source in buyablesSources">
                                                <input class="form-check-input" :id="'buyablesCheck' + source" type="checkbox" :value="source" v-model="tb.settings.buyablesSource" :disabled="tb.settings.buyablesSourceAll">
                                                <label class="form-check-label" :for="'buyablesCheck' + source">%% source == 'none' ? 'No Source' : source %%</label>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="Sets the logic type for considering buyability. This only checks for existence in the buyables database and does not consider price."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="buyableLogic">Buyability logic:</label>
                                <select id="buyableLogic" v-model="tb.settings.buyableLogic" class="form-control form-control-sm">
                                    <option value="none">None</option>
                                    <option value="or">Or</option>
                                    <option value="and">And</option>
                                </select>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="Sets the logic type for considering max chemical price."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="ppgLogic">Chemical price logic:</label>
                                <select id="ppgLogic" v-model="tb.settings.maxPPGLogic" class="form-control form-control-sm">
                                    <option value="none">None</option>
                                    <option value="or">Or</option>
                                    <option value="and">And</option>
                                </select>
                            </div>
                            <div v-if="tb.settings.maxPPGLogic!='none'" class="form-inline mb-2 ml-3">
                                <i title="This is the maximum price below which a precursor will be considered terminal in the MCTS search."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxPPG">Max chemical price ($/g):</label>
                                <input id="maxPPG" style="width: 100px" class="form-control form-control-sm text-center" type="number" v-model.number="tb.settings.maxPPG">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="Sets the logic type for considering max scscore."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="scscoreLogic">Chemical SCScore logic:</label>
                                <select id="scscoreLogic" v-model="tb.settings.maxScscoreLogic" class="form-control form-control-sm">
                                    <option value="none">None</option>
                                    <option value="or">Or</option>
                                    <option value="and">And</option>
                                </select>
                            </div>
                            <div v-if="tb.settings.maxScscoreLogic!='none'" class="form-inline mb-2 ml-3">
                                <i title="This is the maximum synthetic complexity score below which a precursor will be considered terminal in the MCTS search. Values range from 1-5, with 5 being most synthetically complex."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxScscore">Max chemical SCScore (1-5):</label>
                                <input id="maxScscore" style="width: 100px" class="form-control form-control-sm text-center" type="number" min=1 max=5 v-model.number="tb.settings.maxScscore">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="Sets the logic type for considering maximum chemical size in terms of element counts."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="chemPropLogic">Chemical property logic:</label>
                                <select id="chemPropLogic" v-model="tb.settings.chemicalPropertyLogic" class="form-control form-control-sm">
                                    <option value="none">None</option>
                                    <option value="or">Or</option>
                                    <option value="and">And</option>
                                </select>
                            </div>
                            <div v-if="tb.settings.chemicalPropertyLogic!='none'" class="form-inline mb-2 ml-3">
                                <i title="This is the maximum number of each element below which a precursor will be considered terminal in the MCTS search."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <div class="mr-2">Max atoms:</div>
                                <div class="form-group">
                                    <label class="mx-2" for="chemPropC">C &le;</label>
                                    <input id="chemPropC" style="width: 3rem" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.chemicalPropertyC">
                                </div>
                                <div class="form-group">
                                    <label class="mx-2" for="chemPropN">N &le;</label>
                                    <input id="chemPropN" style="width: 3rem" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.chemicalPropertyN">
                                </div>
                                <div class="form-group">
                                    <label class="mx-2" for="chemPropO">O &le;</label>
                                    <input id="chemPropO" style="width: 3rem" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.chemicalPropertyO">
                                </div>
                                <div class="form-group">
                                    <label class="mx-2" for="chemPropH">H &le;</label>
                                    <input id="chemPropH" style="width: 3rem" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.chemicalPropertyH">
                                </div>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="Sets the logic type for considering the number of times a chemical appeared in the training data for the template relevance machine learning model. "
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="chemPopLogic">Chemical popularity logic:</label>
                                <select id="chemPopLogic" v-model="tb.settings.chemicalPopularityLogic" class="form-control form-control-sm">
                                    <option value="none">None</option>
                                    <option value="or">Or</option>
                                    <option value="and">And</option>
                                </select>
                            </div>
                            <div v-if="tb.settings.chemicalPopularityLogic!='none'" class="form-inline mb-2 ml-3">
                                <i title="This is the minimum number of prior occurrences above which a precursor will be considered terminal in the MCTS search."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <div class="mr-2">Min occurrences:</div>
                                <div class="form-group">
                                    <label class="mx-2" for="chemPopR">As reactant &ge;</label>
                                    <input id="chemPopR" style="width: 5rem" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.chemicalPopularityReactants">
                                </div>
                                <div class="form-group">
                                    <label class="mx-2" for="chemPopP">As product &ge;</label>
                                    <input id="chemPopP" style="width: 5rem" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.chemicalPopularityProducts">
                                </div>
                            </div>
                            <h5>Result output options</h5>
                            <div class="form-inline mb-2">
                                <i title="This setting will make the tree search algorithm terminate upon finding any pathway with terminal nodes that meet the stopping criteria (price, and or property/popularity logic)."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="returnFirst" type="checkbox" v-model="tb.settings.returnFirst" {{ tb.settings.returnFirst }}/>
                                <label class="form-check-label" for="returnFirst">Return ASAP?</label>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This allows limiting how many pathways are returned by the tree builder. Note that the cutoff is checked during depth-first pathway enumeration, so there is no guarantee on which pathways are returned."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <label class="mr-2" for="maxTrees">Maximum pathways to return:</label>
                                <input id="maxTrees" style="width: 100px" class="form-control form-control-sm text-center" type="number" min="1" step="1" v-model.number="tb.settings.maxTrees">
                            </div>
                            <div class="form-inline mb-2">
                                <i title="This setting allows you to redirect to the entire graph visualization of the tree builder results in this IPP interface instead of the pathway visualization page that lets you view individual pathways one at a time."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="redirectToGraph" type="checkbox" v-model="tb.redirectToGraph" {{ tb.redirectToGraph }}/>
                                <label class="form-check-label" for="redirectToGraph">Redirect to entire graph visualization?</label>
                            </div>
                            <hr>
                            <h4>IPP Clustering Settings:</h4>
                            <div class="form-inline mb-2">
                                <i title="This setting lets you turn on or off the precursor clustering."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="allowCluster" type="checkbox" ref="allowCluster" v-model="allowCluster" {{ allowCluster }}/>
                                <label class="form-check-label" for="allowCluster">Show similar precursors in one cluster?</label>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="When enabled, this option will color alternating results in the results list slightly different shades, for easier viewing."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="isAltColor" type="checkbox" ref="clusterOptions.isAlternatingColor" v-model="clusterOptions.isAlternatingColor" {{ clusterOptions.isAlternatingColor }}/>
                                <label class="form-check-label" for="isAltColor">Show alternating color for different reaction clusters?</label>
                            </div>
                            <div class="form-inline mb-2">
                                <i title="When enabled, users can remove precursor results completely using the delete button in the clustering UI."
                                    class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                <input class="form-check-input" id="allowRemovePrecursor" type="checkbox" ref="clusterOptions.allowRemovePrecursor" v-model="clusterOptions.allowRemovePrecursor" {{ clusterOptions.allowRemovePrecursor }}/>
                                <label class="form-check-label" for="allowRemovePrecursor">Allow to remove precursors?</label>
                            </div>
                            <div class="form-inline mb-2">
                                <div class="form-group mr-2">
                                    <i title="This clustering parameter determines which fingerprint features are used as input to the clustering algorithm."
                                        class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                    <label class="mr-2" for="clusterFeature">Feature:</label>
                                    <select id="clusterFeature" v-model="clusterOptions.feature" class="form-control form-control-sm">
                                        <option value="original">original</option>
                                        <option value="outcomes">outcomes</option>
                                        <option value="all">all</option>
                                    </select>
                                </div>
                                <div class="form-group mr-2">
                                    <i title="This setting let's you choose between 'kmeans' and 'hdbscan' clustering algorithms."
                                        class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                    <label class="mr-2" for="clusterMethod">Method:</label>
                                    <select id="clusterMethod" v-model="clusterOptions.cluster_method" class="form-control form-control-sm">
                                        <option value="kmeans">kmeans</option>
                                        <option value="hdbscan">hdbscan</option>
                                    </select>
                                </div>
                                <div class="form-group mr-2">
                                    <i title="Currently only morgan fingerprint methods are supported."
                                        class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                    <label class="mr-2" for="clusterFingerprint">Fingerprint:</label>
                                    <select id="clusterFingerprint" v-model="clusterOptions.fingerprint" class="form-control form-control-sm">
                                        <option value="morgan">Morgan</option>
                                    </select>
                                </div>
                                <div class="form-group mr-2">
                                    <i title="This setting changes the fixed length folding used for constructing morgan fingerprints for clustering."
                                        class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                    <label class="mr-2" for="clusterBits">Length:</label>
                                    <input id="clusterBits" style="width: 50px" type="number" v-model.number="clusterOptions.fpBits" class="form-control form-control-sm">
                                </div>
                                <div class="form-group mr-2">
                                    <i title="This setting changes the radius used for constructing morgan fingerprints for clustering."
                                        class="fas fa-question-circle mr-1" style="cursor: pointer"></i>
                                    <label class="mr-2" for="clusterRadius">Radius:</label>
                                    <input id="clusterRadius" style="width: 50px" type="number" v-model.number="clusterOptions.fpRadius" class="form-control form-control-sm">
                                </div>
                            </div>
                            <hr>
                            <h4>Graph Visualization Settings:</h4>
                            <div class="form-inline mb-2">
                                <label class="mr-2" for="graphSpringConst">Edge spring constant: %% networkOptions.physics.barnesHut.springConstant %%</label>
                                <input id="graphSpringConst" type="range" min="0" max="0.3" step="0.005" v-model.number="networkOptions.physics.barnesHut.springConstant" class="slider" @input="updateNetworkOptions()">
                            </div>
                            <div class="form-inline mb-2">
                                <label class="mr-2" for="graphNodeSize">Chemical node size: %% networkOptions.nodes.size %%</label>
                                <input id="graphNodeSize" type="range" min="1" max="60" step="1" v-model.number="networkOptions.nodes.size" class="slider" @input="updateNetworkOptions()">
                            </div>
                            <div class="form-inline mb-2">
                                <label class="mr-2" for="graphFontSize">Reaction node size: %% networkOptions.nodes.font.size %%</label>
                                <input id="graphFontSize" type="range" min="1" max="20" step="1" v-model.number="networkOptions.nodes.font.size" class="slider" @input="updateNetworkOptions()">
                            </div>
                            <div class="form-inline mb-2">
                                <label class="mr-2" for="graphNodeMass">Node effective mass: %% networkOptions.nodes.mass %%</label>
                                <input id="graphNodeMass" type="range" min="0.1" max="5" step="0.1" v-model.number="networkOptions.nodes.mass" class="slider" @input="updateNetworkOptions()">
                            </div>
                            <div class="form-inline mb-2">
                                <input class="form-check-input" id="checkHier" type="checkbox" v-model="networkOptions.layout.hierarchical.enabled" {{ networkOptions.layout.hierarchical.enabled }} @change="updateNetworkOptions()"/>
                                <label class="form-check-label" for="checkHier">Hierarchical layout?</label>
                            </div>
                            <div class="form-inline mb-2" v-if="networkOptions.layout.hierarchical.enabled">
                                <label class="mr-2" for="graphHierDir">Hierarchical direction:</label>
                                <select id="graphHierDir" v-model="networkOptions.layout.hierarchical.direction" class="form-control form-control-sm" @change="updateNetworkOptions()">
                                    <option value="UD">Top-down</option>
                                    <option value="LR">Left-right</option>
                                    <option value="DU">Bottom-up</option>
                                    <option value="RL">Right-left</option>
                                </select>
                            </div>
                            <div class="form-inline mb-2" v-if="networkOptions.layout.hierarchical.enabled">
                                <label class="mr-2" for="graphLevelSep">Hierarchical level separation: %% networkOptions.layout.hierarchical.levelSeparation %%</label>
                                <input id="graphLevelSep" type="range" min="1" max="500" step="1" v-model.number="networkOptions.layout.hierarchical.levelSeparation" class="slider" @input="updateNetworkOptions()">
                            </div>
                        </div> <!-- end modal body -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" @click="showSettingsModal = false">Close</button>
                            <button type="button" class="btn btn-danger" @click="resetSettings()">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <div class="container-fluid">
            <div class="row">
                <div class="col-md-7 text-center left-pane">

                <div class="d-flex justify-content-center my-2">
                    <form class="form-inline" autocomplete="off" v-on:submit.prevent="changeTarget">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Target</span>
                                <button v-if="enableResolve" class="input-group-text" type="button" @click="toggleResolver">
                                    <i v-if="allowResolve" style="color: darkgreen" class="fas fa-server" title="Connection to NIH name resolver is ON, structures may be sent to an external service. This can be turned off in the settings menu, or by clicking this icon."></i>
                                    <i v-else style="color: darkred" class="fas fa-server" title="Connection to NIH name resolver is OFF, structures will NOT be sent to an external service. Target query must be a SMILES string. This can be turned on in the settings menu, or by clicking this icon."></i>
                                </button>
                            </div>
                            <input id="target" type="text" class="form-control text-center" v-model="target">
                            <div class="input-group-append">
                                <button class="input-group-text" type="button" @click="drawBoxKetcher('target')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                        <input id="submit" type="submit" value="One-Step" class="btn btn-success mx-2" />
                        <div class="btn-group">
                            <button @click="sendTreeBuilderJob" id="tb-submit" type="button" class="btn btn-outline-dark" :disabled="!isAuth" :title="isAuth ? 'Build tree' : 'Must be logged in!'">
                                <i class="fas fa-sign-out-alt"></i> Build tree
                            </button>
                            <button id="tb-submit-settings" class="btn btn-outline-dark dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" :disabled="!isAuth"><i class="fas fa-cog"></i>
                                <span class="caret"></span>
                                <span class="sr-only">Toggle Dropdown</span>
                            </button>
                            <div class="dropdown-menu" aria-labelledby="tb-submit-settings">
                                <span class="px-2">
                                    <input type="text" v-model="tb.settings.name" class="form-control" placeholder="Job name/description">
                                </span>
                                <div class="dropdown-divider"></div>
                                <h5 class="dropdown-header"><b>Quick Settings</b></h5>
                                <a class="dropdown-item" @click="tbSettings('quickest')" style="cursor: pointer">
                                    <i v-if="isTbQuickSettingsMode('quickest')" class="fas fa-check"></i>
                                    Quickest search (ASAP)
                                </a>
                                <a class="dropdown-item" @click="tbSettings('shallow')" style="cursor: pointer">
                                    <i v-if="isTbQuickSettingsMode('shallow')" class="fas fa-check"></i>
                                    Shallow search (30s)
                                </a>
                                <a class="dropdown-item" @click="tbSettings('normal')" style="cursor: pointer">
                                    <i v-if="isTbQuickSettingsMode('normal')" class="fas fa-check"></i>
                                    Normal search (60s)
                                </a>
                                <a class="dropdown-item" @click="tbSettings('deep')" style="cursor: pointer">
                                    <i v-if="isTbQuickSettingsMode('deep')" class="fas fa-check"></i>
                                    Deep search (120s)
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" @click="showSettingsModal = true" style="cursor: pointer">
                                    Advanced...
                                </a>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="d-flex justify-content-center align-items-center my-2">
                    <button id="expand-btn" class="btn btn-success mx-1" v-on:click="expandNode" title="Expand node">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="delete-btn" class="btn btn-danger mx-1" v-on:click="deleteChoice" title="Delete node(s)">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button id="collapse-btn" class="btn btn-info mx-1" v-on:click="collapseNode" title="Collapse children node">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                    <span class="mx-2">|</span>
                    <button id="clear-reactions-btn" class="btn btn-outline-dark mx-1" @click="clear()" title="Clear reactions"><i class="fas fa-times"></i></button>
                    <button id="settings-btn" class="btn btn-outline-dark mx-1" @click="openModal('settings')" title="Settings"><i class="fas fa-cog"></i></button>
                    <button @click="toggleHierarchical" id="hierarchical-button" class="btn btn-outline-dark mx-1">
                        %% networkOptions.layout.hierarchical.enabled ? 'H' : 'G' %%
                    </button>
                    <button @click="centerGraph" id="center-graph-button" class="btn btn-outline-dark mx-1" title="Fit graph visualization in canvas">
                        <i class="fas fa-expand"></i>
                    </button>
                    <button id="download-btn" class="btn btn-outline-dark mx-1" @click="openModal('download')" title="Download reaction network"><i class="fas fa-download"></i></button>
                    <button id="load-btn" class="btn btn-outline-dark mx-1" @click="openModal('load')" title="Upload reaction network"><i class="fas fa-upload"></i></button>
                    <button class="btn btn-outline-dark mx-1" @click="startTour" title="Start tutorial"><i class="fas fa-question"></i></button>
                </div>

                <div class="d-flex justify-content-center align-items-center my-2">
                    <i @click="showSettingsModal = true" class="fas fa-edit" style="cursor: pointer"></i>&nbsp;
                    Using template set&nbsp;<samp><code>%% tb.settings.templateSet %%</code></samp>&nbsp;
                    version&nbsp;<samp><code>%% tb.settings.templateSetVersion %%</code></samp>
                    <div v-if="templateAttributes && templateAttributes[tb.settings.templateSet] && tb.settings.attributeFilter.length">
                        &nbsp;with <samp><code>%% tb.settings.attributeFilter.length %%</code></samp> active attribute filters
                    </div>
                </div>

                <div id="network" class="mx-auto my-2"></div>

                </div>
                <div id="details" class="col-md-5 text-center details">
                    <h3>Currently selected:</h3>

                    <template v-if="selected">
                        <template v-if="selected.type=='chemical'">
                            <div class="details-top">
                                <div class="text-center">
                                    <div id="selected-smiles" class="customtooltip" @click="copySelectedSmiles">
                                        <i class="far fa-copy"></i>
                                        <b>Smiles: </b>
                                        %% selected.smiles %%
                                        <span id="copy-tooltip" class="customtooltiptext">
                                            Click to copy!
                                        </span>
                                    </div>
                                    <div>
                                        <b>Price ($/g): </b>%% selected.ppg %%
                                    </div>
                                    <div v-if="selected.source">
                                        <b>Source: </b>%% selected.source %%
                                    </div>
                                    <div class="my-2">
                                        <img v-bind:src="selected.image" style="max-width: 100%"/>
                                    </div>
                                    <h3>
                                        Precursors
                                        <button class="btn btn-success ml-2" @click="openAddNewPrecursorModal(clusterEditModalData['selectedSmiles'], undefined);">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </h3>
                                    <div class="form-inline flex-column justify-content-center">
                                        <div class="form-group mb-2">
                                            <label class="mr-2" for="allowCluster">Group similar</label>
                                            <input id="allowCluster" type="checkbox" ref="allowCluster" v-model="allowCluster" @change="resetSortingCategory" {{ allowCluster }}/>
                                        </div>
                                        <div v-if="!allowCluster" class="form-group mb-2">
                                            <label class="mr-2" for="sortingCategory">Sort by:</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend" @click="sortOrderAscending = !sortOrderAscending; reorderResults()">
                                                    <button class="input-group-text" v-if="sortOrderAscending">Ascending <i class="fas fa-sort-amount-up ml-1"></i></button>
                                                    <button class="input-group-text" v-else>Descending <i class="fas fa-sort-amount-down ml-1"></i></button>
                                                </div>
                                                <select class="form-control" id="sortingCategory" @change="handleSortingChange" v-model="sortingCategory">
                                                    <option value="score">Score</option>
                                                    <option value="scscore">Synthetic complexity</option>
                                                    <option value="num_examples"># Examples</option>
                                                    <option value="template_score">Template score</option>
                                                    <option value="plausibility">Plausibility</option>
                                                    <option value="rms_molwt">Root mean square molecular weight</option>
                                                    <option value="num_rings">Number of rings</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="scroll-list" style="max-height: calc(100vh - 40rem)">
                                <div class="text-center">
                                    <template v-if="typeof(results[selected.smiles]) == 'undefined'">
                                        <div class="text-center" style="margin-top: 10px">
                                            <h5>Click button below to expand this node and predict precursors for this target.</h5>
                                            <button id="expand-btn-side" class="btn btn-success" v-on:click="expandNode">Expand node</button>
                                        </div>
                                        <div class="form-inline mb-2">
                                            <div class="form-group">
                                            Add top
                                            <input type="number" class="form-control text-center mx-2" style="width: 3rem;" v-model.number="reactionLimit">
                                            %% allowCluster ? 'clusters' : 'precursors' %% to the graph visualization
                                            </div>
                                        </div>
                                    </template>
                                    <template v-if="allowCluster">
                                        <ul v-bind:class="{'card-list-alternating':clusterOptions.isAlternatingColor, 'ul-card':true}">
                                            <template v-for="cluster in clusteredResults[selected.smiles]">
                                                <li>
                                                    <template v-for="(res, index) in cluster">
                                                        <template v-if="res.show">
                                                            <div v-bind:class="{'card-first': index==0, 'card-rest': index!=0}">
                                                                <div class="container-fluid">
                                                                    <div class="row no-gutters">
                                                                        <div class="col-sm">
                                                                            <img v-bind:src="getMolDrawEndPoint(res, undefined, true)" style="max-width: 100%"/>
                                                                        </div>
                                                                        <div class="col-sm">
                                                                            <table class="table table-sm table-bordered m-0">
                                                                                <tbody>
                                                                                    <tr>
                                                                                        <td>Rank</td>
                                                                                        <td>#%% res.rank %%</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td>Score</td>
                                                                                        <td>%% num2str(res.score, 3) %%</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td>Synthetic complexity</td>
                                                                                        <td>%% num2str(res.scscore, 3) %%</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td># Examples</td>
                                                                                        <td>%% num2str(res.num_examples) %%</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td>Template score</td>
                                                                                        <td>%% num2str(res.template_score, 3) %%</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td>Plausibility</td>
                                                                                        <td>%% num2str(res.plausibility, 3) %%</td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <td>Reaction cluster</td>
                                                                                        <td>%% num2str(res.group_id+1) %%</td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col text-center my-2">
                                                                            <button v-show="!res.inViz" class="addRes btn btn-success" :data-rank="res.rank" @click="addFromResults(selected, res)"><i class="fas fa-plus"></i></button>
                                                                            <button v-show="res.inViz" class="remRes btn btn-danger" :data-rank="res.rank" @click="remFromResults(selected, res)"><i class="fas fa-minus"></i></button>
                                                                            <button class="btn btn-outline-dark" :data-rank="res.rank" @click="openClusterPopoutModal(selected, res)"><i class="fa fa-th-large"></i></button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </template>
                                                </li>
                                            </template>
                                        </ul>
                                    </template>
                                    <template v-else>
                                        <template v-for="res in results[selected.smiles]">
                                            <div class="card">
                                                <div class="container-fluid">
                                                    <div class="row no-gutters">
                                                        <div class="col-sm">
                                                            <img v-bind:src="getMolDrawEndPoint(res)" style="max-width: 100%"/>
                                                        </div>
                                                        <div class="col-sm">
                                                            <table class="table table-sm table-bordered m-0">
                                                                <tbody>
                                                                    <tr>
                                                                        <td>Rank</td>
                                                                        <td>#%% res.rank %%</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Score</td>
                                                                        <td>%% num2str(res.score, 3) %%</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Synthetic complexity</td>
                                                                        <td>%% num2str(res.scscore, 3) %%</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td># Examples</td>
                                                                        <td>%% num2str(res.num_examples) %%</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Template score</td>
                                                                        <td>%% num2str(res.template_score, 3) %%</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Plausibility</td>
                                                                        <td>%% num2str(res.plausibility, 3) %%</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Reaction cluster</td>
                                                                        <td>%% num2str(res.group_id+1) %%</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col text-center my-2">
                                                            <button v-show="!res.inViz" class="addRes btn btn-success" :data-rank="res.rank" @click="addFromResults(selected, res)"><i class="fas fa-plus"></i></button>
                                                            <button v-show="res.inViz" class="remRes btn btn-danger" :data-rank="res.rank" @click="remFromResults(selected, res)"><i class="fas fa-minus"></i></button>
                                                            <button class="btn btn-outline-dark" :data-rank="res.rank" @click="openClusterPopoutModal(selected, res)"><i class="fa fa-th-large"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </template>
                        <template v-else-if="selected.type=='reaction'">
                            <div class="details-top">
                                <div class="text-left">
                                    <div class="text-center">
                                        <div id="selected-smiles" class="customtooltip" @click="copySelectedSmiles">
                                            <i class="far fa-copy"></i>
                                            <b>Smiles: </b>
                                            %% selected.reactionSmiles %%
                                            <span id="copy-tooltip" class="customtooltiptext">
                                                Click to copy!
                                            </span>
                                        </div>
                                        <img v-bind:src="'/api/v2/draw/?smiles='+encodeURIComponent(selected.reactionSmiles)" style="max-width: 100%"/>
                                    </div>
                                    <div class="text-center my-2">
                                        <a :href="'/synth_interactive/?mode=context&rxnsmiles='+encodeURIComponent(selected.reactionSmiles)" target="_blank">
                                            Evaluate reaction in new tab
                                        </a>
                                    </div>
                                    <div><b>Retroscore: </b>%% selected.retroscore %%</div>
                                    <div><b>Template score: </b>%% selected.templateScore %%</div>
                                    <div><b>Plausibility: </b>%% selected.ffScore %%</div>
                                    <div><b>Num. Examples: </b>%% selected.numExamples %%</div>
                                    <div><b>Supporting templates:</b>
                                        <ul>
                                            <li v-for="id in selected.templateIds">
                                                <a v-bind:href="'/template/?id='+id" target="_blank">%% id %% (%% templateNumExamples[id] %% examples)</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-warning" v-if="selected['selec_error']">
                                Could not check regio-selectivity for this reaction, possibly due to stereochemistry in the product.
                            </div>
                            <template v-if="'outcomes' in selected">
                                <hr class="my-2">
                                <div class="text-center mb-2">
                                    <h3>Regio-selective Products</h3>
                                    <button id="predict-selectivity" v-on:click="predictSelectivity" class="btn btn-success">Predict selectivity</button>
                                </div>
                                <div class="scroll-list" style="max-height: calc(100vh - 50rem)">
                                    <div class="grid-wrapper">
                                        <template v-for="(res, index) in selected.outcomes">
                                            <div class="card">
                                                <div class="container-fluid d-flex flex-column h-100 justify-content-between">
                                                    <div class="row">
                                                        <div class="col-sm">
                                                            <img v-bind:src="getMolDrawEndPoint(res)" class="m-1" :class="res === selected.reactionSmiles.split('>>')[1] ? 'grey-border' : ''" style="max-width: 100%"/>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-sm" v-if="selected.selectivity[index]">
                                                            Score %% num2str(selected.selectivity[index], 3) %%
                                                            <span v-if="selected.selectivity[index] === Math.max(...selected.selectivity)">
                                                                <i class="fas fa-check"></i>
                                                            </span>
                                                            <span v-else>
                                                                <i class="fas fa-times"></i>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </template>
                    <template v-else>
                        Select a node from the graph to the left to see more detailed information.
                    </template>
                </div>
            </div>
        </div>
    </main>
</div>

<a id="downloadAnchorElem" style="display:none"></a>

{% endblock %}

{% block javascript %}
<script>
var isAuth = '{{ user.is_authenticated }}' == 'True'
</script>

<script src="{% static 'js/network.js' %}?v{{ static_version }}"></script>

<script>
$('#savepage').off('click').on('click', function(e) {
    alert('This page cannot be saved like the others! Instead, please download the graph network using the download button above the target input field. This will download the graph structure in JSON format to your computer. It can later be re-uploaded to this user interface or post-processed externally.');
})
</script>
{% endblock %}
